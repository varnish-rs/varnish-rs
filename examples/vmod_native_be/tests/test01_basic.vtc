varnishtest "Native backend basic test"

# Start a simple backend server
server s1 {
    rxreq
    expect req.url == "/test"
    txresp -body "Hello from native backend"
} -start

# Varnish with native backend VMOD
varnish v1 -vcl+backend {
    import native_be from "${vmod}";

    sub vcl_init {
        new mybackend = native_be.backend(
            host = "${s1_addr}",
            port = ${s1_port}
        );
    }

    sub vcl_recv {
        set req.backend_hint = mybackend.backend();
        return (pass);
    }
} -start

client c1 {
    txreq -url "/test"
    rxresp
    expect resp.status == 200
    expect resp.body == "Hello from native backend"
} -run
