varnishtest "Test round-robin director JSON list output"

server s1 {
    rxreq
    txresp
} -start

server s2 {
    rxreq
    txresp
} -start

server s3 {
    rxreq
    txresp
} -start

varnish v1 -vcl+backend {
    import round_robin from "${vmod}";

    sub vcl_init {
        new rr = round_robin.rr();
        rr.add_backend(s1);
        rr.add_backend(s2);
        rr.add_backend(s3);
    }

    sub vcl_recv {
        set req.backend_hint = rr.backend();
        return(pass);
    }
} -start

# Test JSON output with all backends healthy
shell -match {^\[ [0-9]+, \["backend\.list", "-j", "vcl1\.rr"\], [0-9]+\.[0-9]+,
\{
  "type": "roundrobin",
  "admin_health": "probe",
  "probe_message": \[3, 3, "healthy"\],
  "backends": \[
    "vcl1\.s1",
    "vcl1\.s2",
    "vcl1\.s3"
  \],
  "last_change": [0-9]+\.[0-9]+
\}
\]$} {
    varnishadm -n ${v1_name} backend.list -j vcl1.rr
}

# Mark one backend as sick
varnish v1 -cliok "backend.set_health vcl1.s2 sick"

# Test JSON output with one backend unhealthy
shell -match {^\[ [0-9]+, \["backend\.list", "-j", "vcl1\.rr"\], [0-9]+\.[0-9]+,
\{
  "type": "roundrobin",
  "admin_health": "probe",
  "probe_message": \[2, 3, "healthy"\],
  "backends": \[
    "vcl1\.s1",
    "vcl1\.s2",
    "vcl1\.s3"
  \],
  "last_change": [0-9]+\.[0-9]+
\}
\]$} {
    varnishadm -n ${v1_name} backend.list -j vcl1.rr
}

# Make a request to ensure director still works
client c1 {
    txreq
    rxresp
    expect resp.status == 200
} -run
