varnishtest "Test round-robin director list functionality"

server s1 -start
server s2 -start
server s3 -start

varnish v1 -vcl+backend {
    import round_robin from "${vmod}";
    import std;

    sub vcl_init {
        new rr = round_robin.rr();
        rr.add_backend(s1);
        rr.add_backend(s2);
        rr.add_backend(s3);
    }

    sub vcl_recv {
        set req.backend_hint = rr.backend();
        return(pass);
    }
} -start

# Check that the director shows up in backend.list
varnish v1 -cliok "backend.list"
varnish v1 -cliexpect "vcl1.rr        probe     3/3     healthy   " "backend.list"

varnish v1 -cliok "backend.set_health *.s2 sick"


# Check that the director shows up in backend.list
varnish v1 -cliok "backend.list"
varnish v1 -cliexpect "vcl1.rr        probe     2/3     healthy   " "backend.list"
